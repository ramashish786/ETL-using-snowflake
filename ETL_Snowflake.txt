USE SCHEMA ETL_TO_AZURE;

CREATE OR REPLACE TABLE LANDING_FINANCE_TABLE(RECORDNO INT,TYPE VARCHAR(50),COMPONENT VARCHAR(60),ENTRY_DATE DATE,VALUE INT);

CREATE OR REPLACE TABLE STAGING_FINANCE_TABLE(RECORDNO INT,TYPE VARCHAR(50),COMPONENT VARCHAR(60),ENTRY_DATE DATE,VALUE INT);

CREATE OR REPLACE STREAM LANDING_TO_FINANCE_TABLE ON TABLE ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE APPEND_ONLY = TRUE;



CREATE OR REPLACE TASK TO_APPEND_FINANCE_TABLE
WAREHOUSE = COMPUTE_WH
WHEN
SYSTEM$STREAM_HAS_DATA('ETL_DB.ETL_TO_AZURE.LANDING_TO_FINANCE_TABLE')
AS 
MERGE INTO STAGING_FINANCE_TABLE USING LANDING_FINANCE_TABLE
ON STAGING_FINANCE_TABLE.RECORDNO = LANDING_FINANCE_TABLE.RECORDNO
WHEN MATCHED THEN
UPDATE SET 
STAGING_FINANCE_TABLE.TYPE = LANDING_FINANCE_TABLE.TYPE,
STAGING_FINANCE_TABLE.COMPONENT = LANDING_FINANCE_TABLE.COMPONENT,
STAGING_FINANCE_TABLE.ENTRY_DATE = LANDING_FINANCE_TABLE.ENTRY_DATE,
STAGING_FINANCE_TABLE.VALUE = LANDING_FINANCE_TABLE.VALUE
WHEN NOT MATCHED THEN
INSERT(RECORDNO,TYPE,COMPONENT,ENTRY_DATE,VALUE)
VALUES(LANDING_FINANCE_TABLE.RECORDNO,LANDING_FINANCE_TABLE.TYPE,LANDING_FINANCE_TABLE.COMPONENT,LANDING_FINANCE_TABLE.ENTRY_DATE,LANDING_FINANCE_TABLE.VALUE);

INSERT INTO ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE(RECORDNO,TYPE,COMPONENT,ENTRY_DATE,VALUE)
VALUES(52,'Savings','Liquid Cash','2021-05-01',38600);

SELECT * FROM ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE;

SELECT * FROM ETL_DB.ETL_TO_AZURE.STAGING_FINANCE_TABLE;

ALTER TASK TO_APPEND_FINANCE_TABLE SUSPEND;
ALTER TASK TO_APPEND_STUDENT UNSET SCHEDULE;
ALTER TASK TO_APPEND_FINANCE_TABLE RESUME;

SHOW TASKS;


-- creating storage integration

CREATE OR REPLACE STORAGE INTEGRATION SNOWPIPE_STORAGE_INTEGRATION_AZ
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = AZURE
ENABLED = TRUE
AZURE_TENANT_ID = 'Your Azure Tenant'
STORAGE_ALLOWED_LOCATIONS = ('azure://etlazuretosnowflake.blob.core.windows.net/rawdata');

--provide permission to starage integration in azure with help of azure_consent_url
DESC STORAGE INTEGRATION SNOWPIPE_STORAGE_INTEGRATION_AZ;

-- Creating file format with CSV
CREATE OR REPLACE FILE FORMAT FORMAT_CSV
TYPE = CSV
FIELD_DELIMITER = ','
SKIP_HEADER = 1

-- Creating stage
CREATE OR REPLACE STAGE AZURE_ETL_STAGE 
STORAGE_INTEGRATION = SNOWPIPE_STORAGE_INTEGRATION_AZ
URL = 'azure://etlazuretosnowflake.blob.core.windows.net/rawdata'
FILE_FORMAT = FORMAT_CSV;


LIST @ETL_DB.ETL_TO_AZURE.AZURE_ETL_STAGE;

-- Testing whether data is being copied or not
COPY INTO ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE
FROM @ETL_DB.ETL_TO_AZURE.AZURE_ETL_STAGE
FILE_FORMAT = ETL_DB.ETL_TO_AZURE.FORMAT_CSV
PATTERN='.*data.*[.]csv';

TRUNCATE TABLE ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE;

TRUNCATE TABLE ETL_DB.ETL_TO_AZURE.STAGING_FINANCE_TABLE;

SELECT * FROM ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE;

SELECT * FROM ETL_DB.ETL_TO_AZURE.STAGING_FINANCE_TABLE;

-- INSERT INTO ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE(RECORDNO,TYPE,COMPONENT,ENTRY_DATE,VALUE) VALUES(6,'Savings','Liquid Cash','2021-01-01',35600);

--Creating notification integration fro pipe
CREATE OR REPLACE NOTIFICATION INTEGRATION SNOWPIPE_EVENT
ENABLED = TRUE
TYPE = QUEUE
NOTIFICATION_PROVIDER = AZURE_STORAGE_QUEUE
AZURE_STORAGE_QUEUE_PRIMARY_URI = ''
AZURE_TENANT_ID = 'Your Azure Tenant'


--provide permission to starage integration in azure with help of azure_consent_url
DESC NOTIFICATION INTEGRATION SNOWPIPE_EVENT;

LIST @ETL_DB.ETL_TO_AZURE.AZURE_ETL_STAGE;

-- Creating snowpipe
CREATE PIPE AZ_PIPE 
AUTO_INGEST = TRUE
INTEGRATION = SNOWPIPE_EVENT
AS 
COPY INTO ETL_DB.ETL_TO_AZURE.LANDING_FINANCE_TABLE
FROM 
@ETL_DB.ETL_TO_AZURE.AZURE_ETL_STAGE;



